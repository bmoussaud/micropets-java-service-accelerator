accelerator:
  displayName: Micropets Java Service
  description: Tanzu Application Platform Accelerator to spin up a new service for the micropets app
  iconUrl: https://github.com/bmoussaud/micropets-java-service-accelerator/raw/main/pet-silhouette-icons.png
  tags:
    - java
    - spring
    - micropets
  options:
    - name: petKind
      label: "Kind"
      display: true
      defaultValue: Bird
      required: true
    - name: pkgName
      label: Package
      description: The name of the package
      dataType: string
      defaultValue: org.moussaud.micropets.pets
    - name: imageRegistry
      label: Image registry
      description: the image registry
      dataType: string
      defaultValue: akseutap2registry.azurecr.io
    - label: Database Type
      description: The type of database that services will connenct to.
      inputType: select
      defaultValue: h2
      name: dbType
      choices:
        - value: postgresql
          text: PostgreSQL
        - value: h2
          text: H2 (In Memory DB)
      required: true
    - label: Create Resource Claim Defintion for Services
      description: "If set to true, a resource claim definition yaml file for the data services will be created."
      defaultValue: true
      name: createResourceClaim
      inputType: checkbox
      dataType: boolean
      required: true
      hidden: true
engine:
  merge:
    - include: ["**/**"]
      exclude:
        [
          "pom.xml",
          "**/*.java",
          ".git",
          "k8s",
          "src/main/java/**",
          "applications/**",
          "ytt/**",
          "k8s/**",
          "config/**",
          "README.md",
          "Tiltfile",
          "Makefile",
          "catalog-info.yaml",
          "src/main/resources/schema-h2.sql",
        ]
    - include: ["pom.xml"]
      chain:
        - type: ReplaceText
          substitutions:
            - text: my-petservice
              with: "#petKind.toLowerCase()+ 's'"
            - text: PetKind
              with: "#petKind"
            - text: pkgName
              with: "#pkgName"
    - include:
        [
          "config/**",
          "README.md",
          "git-push.sh",
          "Tiltfile",
          "catalog-info.yaml",
          "src/main/resources/schema-h2.sql",
          "src/main/resources/application.yml",
        ]
      chain:
        - type: ReplaceText
          substitutions:
            - text: my-petservice
              with: "#petKind.toLowerCase()+ 's'"
            - text: PetKind
              with: "#petKind"
            - text: lowercasePetKind
              with: "#petKind.toLowerCase()+ 's'"
            - text: imageRegistry
              with: "#imageRegistry.toLowerCase()"
    - include: ["**/*.java"]
      chain:
        - type: ReplaceText
          substitutions:
            - text: PetKind
              with: "#petKind"
            - text: lowercasePetKind
              with: "#petKind.toLowerCase()+ 's'"
        - type: OpenRewriteRecipe
          recipe: org.openrewrite.java.ChangePackage
          options:
            oldPackageName: "'com.renamethis'"
            newPackageName: "#pkgName"
    - condition: "#createResourceClaim && #dbType == 'postgresql'"
      include: ["**/postgresqlResourceClaim.yaml"]
      chain:
        - type: YTT
        - type: RewritePath
          regex: "templates/postgresqlResourceClaim.yaml"
          rewriteTo: "'config/app-operator/postgresqlResourceClaim.yaml'"
  chain:
    - type: RewritePath
      regex: (.*)PetKind(.*)
      rewriteTo: "#g1 + #petKind + #g2"
